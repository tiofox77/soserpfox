name: Deploy to Production (cPanel)

on:
  push:
    branches:
      - main
      - master

jobs:
  deploy:
    name: Deploy to cPanel
    runs-on: ubuntu-latest
    
    steps:
      - name: üöÄ Deploy via SSH
        uses: appleboy/ssh-action@v1.0.0
        with:
          host: ${{ secrets.CPANEL_HOST }}
          username: ${{ secrets.CPANEL_USERNAME }}
          password: ${{ secrets.CPANEL_PASSWORD }}
          port: ${{ secrets.CPANEL_PORT || 22 }}
          script: |
            cd ${{ secrets.APP_PATH }}
            
            echo "üöÄ Iniciando deploy..."
            
            # Modo manuten√ß√£o
            php artisan down --render="errors::503" || true
            
            # Atualizar c√≥digo
            git fetch origin
            git reset --hard origin/${{ github.ref_name }}
            
            # Depend√™ncias
            composer install --no-interaction --prefer-dist --optimize-autoloader --no-dev
            
            # Migrations
            php artisan migrate --force
            
            # Atualizar m√≥dulos (garante que novos m√≥dulos s√£o criados)
            php artisan db:seed --class=ModuleSeeder --force
            
            # Cache
            php artisan config:clear
            php artisan cache:clear
            php artisan route:clear
            php artisan view:clear
            php artisan config:cache
            php artisan route:cache
            php artisan view:cache
            
            # Reiniciar filas
            php artisan queue:restart || true
            
            # Voltar online
            php artisan up
            
            echo "‚úÖ Deploy conclu√≠do!"

      - name: üì¢ Notify Success
        if: success()
        run: echo "‚úÖ Deploy realizado com sucesso!"

      - name: ‚ùå Notify Failure
        if: failure()
        run: echo "‚ùå Deploy falhou!"
