# üö® VALIDA√á√ïES DE DESCONTO - N√ÉO IMPLEMENTADAS

## ‚ùå PROBLEMA IDENTIFICADO

As configura√ß√µes de pol√≠tica de descontos est√£o sendo **salvas** mas **N√ÉO est√£o sendo aplicadas** nos documentos de vendas/compras.

**Configura√ß√µes existentes:**
- ‚úÖ `allow_line_discounts` - Salvo no banco
- ‚úÖ `allow_commercial_discount` - Salvo no banco
- ‚úÖ `allow_financial_discount` - Salvo no banco
- ‚úÖ `max_discount_percent` - Salvo no banco

**Status:** ‚ùå N√£o validadas nos formul√°rios de documentos

---

## ‚úÖ SOLU√á√ÉO CRIADA

**Arquivo:** `app/Helpers/DiscountHelper.php`

**M√©todos dispon√≠veis:**
```php
DiscountHelper::isLineDiscountAllowed()           // bool
DiscountHelper::isCommercialDiscountAllowed()     // bool
DiscountHelper::isFinancialDiscountAllowed()      // bool
DiscountHelper::getMaxDiscountPercent()           // float
DiscountHelper::isDiscountValid($percent)         // bool
DiscountHelper::validateDiscount($percent, $type) // array
DiscountHelper::getDiscountErrorMessage($percent, $type) // string|null
```

---

## üìã ONDE IMPLEMENTAR

### **1. Faturas de Venda** üìÑ
**Arquivo:** `app/Livewire/Invoicing/Sales/InvoiceCreate.php`

**No m√©todo de adicionar item:**
```php
use App\Helpers\DiscountHelper;

public function addItem()
{
    // ... c√≥digo existente ...
    
    // VALIDAR DESCONTO POR LINHA
    if ($this->discount > 0) {
        $validation = DiscountHelper::validateDiscount($this->discount, 'line');
        
        if (!$validation['valid']) {
            $this->dispatch('error', message: $validation['message']);
            return;
        }
    }
    
    // ... resto do c√≥digo ...
}
```

**No m√©todo de calcular totais (desconto comercial):**
```php
public function updatedCommercialDiscount()
{
    if ($this->commercial_discount > 0) {
        $validation = DiscountHelper::validateDiscount($this->commercial_discount, 'commercial');
        
        if (!$validation['valid']) {
            $this->dispatch('error', message: $validation['message']);
            $this->commercial_discount = 0;
            return;
        }
    }
    
    $this->calculateTotals();
}
```

**No m√©todo de desconto financeiro:**
```php
public function updatedFinancialDiscount()
{
    if ($this->financial_discount > 0) {
        $validation = DiscountHelper::validateDiscount($this->financial_discount, 'financial');
        
        if (!$validation['valid']) {
            $this->dispatch('error', message: $validation['message']);
            $this->financial_discount = 0;
            return;
        }
    }
    
    $this->calculateTotals();
}
```

---

### **2. Na View (Blade)** üé®

**Ocultar campos se n√£o permitidos:**

```blade
{{-- Desconto por Linha --}}
@if(App\Helpers\DiscountHelper::isLineDiscountAllowed())
<div>
    <label>Desconto (%)</label>
    <input type="number" wire:model="discount" max="{{ App\Helpers\DiscountHelper::getMaxDiscountPercent() }}">
    <p class="text-xs text-gray-500">
        M√°ximo: {{ App\Helpers\DiscountHelper::getMaxDiscountPercent() }}%
    </p>
</div>
@else
<p class="text-xs text-red-500">
    <i class="fas fa-ban mr-1"></i>
    Desconto por linha n√£o permitido
</p>
@endif

{{-- Desconto Comercial --}}
@if(App\Helpers\DiscountHelper::isCommercialDiscountAllowed())
<div>
    <label>Desconto Comercial (%)</label>
    <input type="number" wire:model="commercial_discount" max="{{ App\Helpers\DiscountHelper::getMaxDiscountPercent() }}">
</div>
@else
<div class="bg-red-50 border border-red-200 rounded p-2 text-xs text-red-600">
    Desconto comercial desativado nas configura√ß√µes
</div>
@endif

{{-- Desconto Financeiro --}}
@if(App\Helpers\DiscountHelper::isFinancialDiscountAllowed())
<div>
    <label>Desconto Financeiro (%)</label>
    <input type="number" wire:model="financial_discount" max="{{ App\Helpers\DiscountHelper::getMaxDiscountPercent() }}">
</div>
@else
<div class="bg-red-50 border border-red-200 rounded p-2 text-xs text-red-600">
    Desconto financeiro desativado nas configura√ß√µes
</div>
@endif
```

---

### **3. Valida√ß√£o no Save** üíæ

**Antes de salvar o documento:**

```php
public function save()
{
    // ... valida√ß√µes existentes ...
    
    // VALIDAR DESCONTOS ANTES DE SALVAR
    foreach ($this->items as $item) {
        if (isset($item['discount']) && $item['discount'] > 0) {
            $validation = DiscountHelper::validateDiscount($item['discount'], 'line');
            if (!$validation['valid']) {
                $this->dispatch('error', message: 'Item com desconto inv√°lido: ' . $validation['message']);
                return;
            }
        }
    }
    
    if ($this->commercial_discount > 0) {
        $validation = DiscountHelper::validateDiscount($this->commercial_discount, 'commercial');
        if (!$validation['valid']) {
            $this->dispatch('error', message: $validation['message']);
            return;
        }
    }
    
    if ($this->financial_discount > 0) {
        $validation = DiscountHelper::validateDiscount($this->financial_discount, 'financial');
        if (!$validation['valid']) {
            $this->dispatch('error', message: $validation['message']);
            return;
        }
    }
    
    // ... continuar com save ...
}
```

---

## üìù ARQUIVOS QUE PRECISAM SER MODIFICADOS

```
‚ùå N√ÉO IMPLEMENTADO:
‚îú‚îÄ‚îÄ app/Livewire/Invoicing/Sales/InvoiceCreate.php
‚îú‚îÄ‚îÄ app/Livewire/Invoicing/Sales/ProformaCreate.php
‚îú‚îÄ‚îÄ app/Livewire/Invoicing/Purchases/InvoiceCreate.php
‚îú‚îÄ‚îÄ app/Livewire/POS/POSSystem.php
‚îî‚îÄ‚îÄ Suas views correspondentes (.blade.php)

‚úÖ CRIADO:
‚îî‚îÄ‚îÄ app/Helpers/DiscountHelper.php (HELPER PRONTO)
```

---

## üéØ EXEMPLO COMPLETO DE USO

### **No Livewire Component:**

```php
<?php

namespace App\Livewire\Invoicing\Sales;

use App\Helpers\DiscountHelper;
use Livewire\Component;

class InvoiceCreate extends Component
{
    public $discount = 0;
    public $commercial_discount = 0;
    public $financial_discount = 0;
    
    // Validar quando usu√°rio digita desconto por linha
    public function updatedDiscount($value)
    {
        if ($value > 0) {
            $validation = DiscountHelper::validateDiscount($value, 'line');
            if (!$validation['valid']) {
                $this->dispatch('error', message: $validation['message']);
                $this->discount = 0;
            }
        }
    }
    
    // Validar desconto comercial
    public function updatedCommercialDiscount($value)
    {
        if ($value > 0) {
            $validation = DiscountHelper::validateDiscount($value, 'commercial');
            if (!$validation['valid']) {
                $this->dispatch('error', message: $validation['message']);
                $this->commercial_discount = 0;
            }
        }
        $this->calculateTotals();
    }
    
    // Validar desconto financeiro
    public function updatedFinancialDiscount($value)
    {
        if ($value > 0) {
            $validation = DiscountHelper::validateDiscount($value, 'financial');
            if (!$validation['valid']) {
                $this->dispatch('error', message: $validation['message']);
                $this->financial_discount = 0;
            }
        }
        $this->calculateTotals();
    }
    
    public function render()
    {
        return view('livewire.invoicing.sales.invoice-create', [
            'maxDiscountAllowed' => DiscountHelper::getMaxDiscountPercent(),
            'lineDiscountAllowed' => DiscountHelper::isLineDiscountAllowed(),
            'commercialDiscountAllowed' => DiscountHelper::isCommercialDiscountAllowed(),
            'financialDiscountAllowed' => DiscountHelper::isFinancialDiscountAllowed(),
        ]);
    }
}
```

### **Na View:**

```blade
<div>
    {{-- Desconto por Linha --}}
    @if($lineDiscountAllowed)
        <div class="mb-4">
            <label class="block text-sm font-medium text-gray-700 mb-2">
                <i class="fas fa-percentage mr-1"></i>
                Desconto (%)
            </label>
            <input type="number" 
                   wire:model.blur="discount" 
                   max="{{ $maxDiscountAllowed }}"
                   step="0.01"
                   class="w-full px-3 py-2 border rounded-lg">
            <p class="text-xs text-gray-500 mt-1">
                <i class="fas fa-info-circle mr-1"></i>
                M√°ximo permitido: {{ $maxDiscountAllowed }}%
            </p>
        </div>
    @else
        <div class="mb-4 p-3 bg-red-50 border border-red-200 rounded-lg">
            <p class="text-sm text-red-600">
                <i class="fas fa-ban mr-1"></i>
                Desconto por linha desativado nas configura√ß√µes
            </p>
        </div>
    @endif
    
    {{-- Desconto Comercial --}}
    @if($commercialDiscountAllowed)
        <div class="mb-4">
            <label class="block text-sm font-medium text-gray-700 mb-2">
                <i class="fas fa-handshake mr-1"></i>
                Desconto Comercial (%)
            </label>
            <input type="number" 
                   wire:model.blur="commercial_discount" 
                   max="{{ $maxDiscountAllowed }}"
                   step="0.01"
                   class="w-full px-3 py-2 border rounded-lg">
        </div>
    @endif
    
    {{-- Desconto Financeiro --}}
    @if($financialDiscountAllowed)
        <div class="mb-4">
            <label class="block text-sm font-medium text-gray-700 mb-2">
                <i class="fas fa-dollar-sign mr-1"></i>
                Desconto Financeiro (%)
            </label>
            <input type="number" 
                   wire:model.blur="financial_discount" 
                   max="{{ $maxDiscountAllowed }}"
                   step="0.01"
                   class="w-full px-3 py-2 border rounded-lg">
        </div>
    @endif
</div>
```

---

## ‚ö†Ô∏è IMPORTANTE

### **Atualmente:**
```
‚ùå Configura√ß√µes s√£o IGNORADAS
‚ùå Qualquer desconto √© aceito
‚ùå N√£o h√° valida√ß√£o
‚ùå Limite m√°ximo n√£o √© verificado
```

### **Ap√≥s Implementar:**
```
‚úÖ Campos desabilitados se configura√ß√£o = false
‚úÖ Valida√ß√£o em tempo real
‚úÖ Mensagem de erro clara
‚úÖ Limite m√°ximo respeitado
‚úÖ Impedimento de salvar se inv√°lido
```

---

## üöÄ PR√ìXIMOS PASSOS

1. ‚úÖ **Helper criado** - `DiscountHelper.php`
2. ‚è≥ **Implementar nos componentes Livewire**
3. ‚è≥ **Atualizar views para usar helper**
4. ‚è≥ **Adicionar valida√ß√µes no save**
5. ‚è≥ **Testar com diferentes configura√ß√µes**

---

## üìä IMPACTO

**Componentes afetados:**
- üî¥ Faturas de Venda
- üî¥ Proformas de Venda
- üî¥ Faturas de Compra
- üî¥ POS (Ponto de Venda)
- üî¥ Recibos
- üî¥ Notas de Cr√©dito/D√©bito

**Todos precisam implementar as valida√ß√µes!**

---

**STATUS ATUAL: ‚ö†Ô∏è HELPER CRIADO, FALTA IMPLEMENTAR NOS COMPONENTES**
